
  åç«¯æµç¨‹ï¼š
1. è°ƒç”¨å¤–éƒ¨è§£ææœåŠ¡ï¼ˆfile_parse_urlï¼‰
2. è°ƒç”¨Â update_docs()Â è¿›è¡Œå‘é‡åŒ–
3. åˆ é™¤æ—§çš„åˆ†å—è®°å½•
4. ä¿å­˜æ–°çš„åˆ†å—è®°å½•
5. æ›´æ–°æ–‡æ¡£çŠ¶æ€ä¸ºå·²å‘é‡åŒ–


## oss.py
åŸºäºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå®ç°çš„ç®€å•å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œæä¾›äº†ï¼š
	å†…å­˜ç¼“å­˜cache
	å†…å­˜ä¸´æ—¶å­˜å‚¨ram
	æœ¬åœ°æ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–
	ï¼ˆåå°çº¿ç¨‹)å¼‚æ­¥å†™å…¥
	çº¿ç¨‹å®‰å…¨ä¿æŠ¤
	è‡ªåŠ¨ç¼“å­˜æ¸…ç†
æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼š
	Upload â†’ ç¼“å­˜cache â†’ï¼ˆå¯é€‰ï¼‰åŠ å…¥ä¿å­˜é˜Ÿåˆ—ï¼ˆå†™å…¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼‰ â†’ åå°çº¿ç¨‹ä¿å­˜ â†’ è‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼›
	Download â†’ å†…å­˜ï¼ˆramï¼‰ â†’ ç¼“å­˜ï¼ˆcacheï¼‰ â†’ ç£ç›˜ â†’ å†™å…¥ç¼“å­˜
**é”çš„ä½¿ç”¨**ï¼š
	1. cache ä½¿ç”¨äº†threading.Lock()
		- ä¿æŠ¤èŒƒå›´
			- self.cache
			- self.cached_size
			- ç¼“å­˜æ¸…ç†é€»è¾‘
	2. ram ä¹Ÿä½¿ç”¨äº†threading.Lock()
		- ä¿æŠ¤èŒƒå›´
			- self.ram
	3. `with` ä¼šè‡ªåŠ¨ acquire å’Œ release
```python
# ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨è°ƒç”¨self.lck.acquire()
# æ‰§è¡Œä»£ç å—
# æ— è®ºæ˜¯å¦æ­£å¸¸ç»“æŸï¼Œéƒ½è‡ªåŠ¨è°ƒç”¨self.lck.release()
with self.lck:
    ...ä»£ç å—
    
# ç­‰ä»·äº
self.lck.acquire()
try:
    ...ä»£ç å—
finally:
    self.lck.release()
```

çº¿ç¨‹çš„ä½¿ç”¨ï¼š
	1. åˆ›å»ºä¸€ä¸ªæ™®é€šçº¿ç¨‹ï¼Œä½œä¸ºåå°çº¿ç¨‹ã€‚ ^d400fc
```python
self.save_thr = threading.Thread(target=self.loop_save)  
self.save_thr.start()
```
	2.è¿™ä¸ªçº¿ç¨‹ä¸€ç›´æ‰§è¡Œloop_saveå‡½æ•°ï¼Œä¸“é—¨è´Ÿè´£å¤„ç†ä¿å­˜ä»»åŠ¡ã€‚
```python
def loop_save(self):
Â  Â  while True:
	Â  Â  ä»£ç å—
```


# kbase ä¸ chatchat çš„è¿æ¥
- kbase_dmsï¼šæ–‡æ¡£ç®¡ç†ç³»ç»Ÿï¼Œè´Ÿè´£æ–‡ä»¶ä¸Šä¼ ã€ç®¡ç†ã€å‘é‡åŒ–
	- æµç¨‹ï¼š
		1. ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£ï¼ˆPDFã€Wordç­‰ï¼‰
		2. ç³»ç»Ÿå°†æ–‡æ¡£è½¬æ¢ä¸ºPDFå¹¶å­˜å‚¨åˆ°OSS
		3. åå°å°†æ–‡æ¡£åˆ‡åˆ†ã€å‘é‡åŒ–ï¼Œå­˜å…¥çŸ¥è¯†åº“
		4. æ–‡æ¡£å…ƒæ•°æ®å­˜å…¥MySQLæ•°æ®åº“

- Langchain-Chatchatï¼šå¯¹è¯ç³»ç»Ÿï¼Œæä¾›çŸ¥è¯†åº“å¯¹è¯åŠŸèƒ½
	- åŠŸèƒ½ï¼šåŸºäºçŸ¥è¯†åº“çš„æ™ºèƒ½å¯¹è¯
	- æµç¨‹ï¼š
		1. ç”¨æˆ·æé—®
		2. ç³»ç»Ÿå°†é—®é¢˜å‘é‡åŒ–ï¼Œåœ¨çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
		3. å°†ç›¸å…³æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œè°ƒç”¨LLMç”Ÿæˆå›ç­”
è¿æ¥ï¼š
- å…±äº«çŸ¥è¯†åº“å­˜å‚¨è·¯å¾„ï¼šä¸¤ä¸ªç³»ç»Ÿä½¿ç”¨åŒä¸€ä¸ªå‘é‡åº“ç›®å½•
- å…±äº«å‘é‡æ•°æ®ï¼škbase_dms åˆ›å»ºçš„å‘é‡ï¼Œchatchat å¯ä»¥ç›´æ¥ä½¿ç”¨


ç°çŠ¶ï¼š
	- çŸ¥è¯†åº“æŸ¥è¯¢æ–‡ä»¶çš„è·¯å¾„æ˜¯ï¼š/mnt/hs-ssd/vllms/Langchain-Chatchat/knowledge_base/{çŸ¥è¯†åº“åç§°}/content/
	- ç°åœ¨çš„å¯¹è¯ç³»ç»Ÿä¸­ï¼ŒçŸ¥è¯†åº“çš„åç§°æ˜¯BZGZ0925ï¼Œä»è€Œæ¨æ–­ç°åœ¨çš„å¯¹è¯ç³»ç»Ÿåœ¨å“ªé‡Œæœç´¢æ–‡ä»¶ã€‚
	- 
- å‘é‡ç´¢å¼•å­˜å‚¨åœ¨ kbase_dms çš„çŸ¥è¯†åº“ç›®å½•ï¼š
	~/DiMS-DAPP/docker_home/kbase_dms/knowledge_base/{çŸ¥è¯†åº“ID}/vector_store/bge-large-zh-v1.5/
	â”œâ”€â”€ index.faiss
	â””â”€â”€ index.pkl




kbaseæä¾›çš„æ¥å£ï¼š
- /bus/files/searchÂ - ä¸šåŠ¡æœç´¢æ¥å£
	- kbase_dms\api\files_kbase.pyä¸­@files_kbase.route("/search", methods="GET")
	- æ ¹æ®å…³é”®è¯æœç´¢æ–‡ä»¶ï¼Œæ”¯æŒå‘é‡æœç´¢å’Œæ–‡ä»¶åæœç´¢ã€‚
	- è¿”å›æ•°æ®ï¼š
		- æ–‡ä»¶ä¿¡æ¯åˆ—è¡¨ï¼ˆ==DbDocument==Â è®°å½•ï¼‰
		- åŒ…å«ï¼šid,Â name,Â kbase_id,Â is_file,Â is_active,Â pdf_pathÂ ç­‰ã€‚ 
		- ä¸åŒ…å«ï¼šæ–‡æœ¬å—çš„å…·ä½“å†…å®¹
- /restful/document_docÂ - æ–‡æœ¬å— CRUD æ¥å£
	- å¯¹æ–‡æœ¬å—è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œç›´æ¥æ“ä½œæ•°æ®åº“è¡¨Â document_to_docã€‚
	- è¿”å›æ•°æ®ï¼š
		- æ–‡æœ¬å—ä¿¡æ¯ï¼ˆ==DbDocumentToDoc==Â è®°å½•ï¼‰
		- åŒ…å«ï¼šid,Â file_id,Â kbase_id,Â doc_id,Â contentï¼ˆæ–‡æœ¬å†…å®¹ï¼‰,Â meta_dataï¼ˆJSONå­—ç¬¦ä¸²ï¼‰,Â embedding,Â create_time
		- ç›´æ¥è¿”å›æ–‡æœ¬å—å†…å®¹
```python
	# 1. æ¥æ”¶å‚æ•°ï¼ˆé€šè¿‡æŸ¥è¯¢å‚æ•°æˆ–è¯·æ±‚ä½“ï¼‰
	params = {
	Â  Â  "id": "æ–‡æœ¬å—ID", Â  Â  Â  Â  Â  # å¯é€‰ï¼šè·å–å•ä¸ªæ–‡æœ¬å—
	Â  Â  "file_id": "æ–‡ä»¶ID", Â  Â  Â  Â # å¯é€‰ï¼šè·å–æŸä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ–‡æœ¬å—
	Â  Â  "kbase_id": "çŸ¥è¯†åº“ID", Â  Â  # å¯é€‰ï¼šè·å–æŸä¸ªçŸ¥è¯†åº“çš„æ‰€æœ‰æ–‡æœ¬å—
	Â  Â  "doc_id": "å‘é‡åº“ID", Â  Â  Â  # å¯é€‰ï¼šæ ¹æ®å‘é‡åº“IDæŸ¥æ‰¾
	Â  Â  "page": 1 Â  Â  Â  Â  Â  Â  Â  Â  Â  # å¯é€‰ï¼šåˆ†é¡µ
	}
	# 2. é€šè¿‡ accessor æŸ¥è¯¢æ•°æ®åº“
	if "id" in params:
	Â  Â  # è·å–å•ä¸ªæ–‡æœ¬å—
	Â  Â  chunk = kbase_document_to_doc_accessor[id]
	Â  Â  return chunk Â # è¿”å›å•ä¸ªå¯¹è±¡
	else:
	Â  Â  # è·å–åˆ—è¡¨ï¼ˆæ”¯æŒè¿‡æ»¤ï¼‰
	Â  Â  chunks = kbase_document_to_doc_accessor.get_all(**params)
Â  Â  return chunks Â # è¿”å›åˆ—è¡¨
```


kabseä¸­æ¥å£çš„ä½¿ç”¨æ–¹æ³•ï¼š
```python
Â  Â  # ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ /bus/files/search æ‰¾åˆ°ç›¸å…³æ–‡ä»¶
		GET /bus/files/search?key_words=äººå·¥æ™ºèƒ½&kbase_names=kb1&search_doc=1
		# è¿”å›çš„æ•°æ®ç¤ºä¾‹
		[
		Â  Â  {
		Â  Â  Â  Â  "id": "file_123", Â  Â  Â  Â  Â  Â  Â // â† è¿™å°±æ˜¯ file_idï¼
		Â  Â  Â  Â  "kbase_id": 1,
		Â  Â  Â  Â  "name": "AIæŠ€æœ¯æ–‡æ¡£.pdf",
		Â  Â  Â  Â  "is_file": 1,
		Â  Â  Â  Â  "is_active": 1,
		Â  Â  Â  Â  "pdf_path": "/path/to/file.pdf",
		Â  Â  Â  Â  "oss_path": "/path/to/file.pdf",
		Â  Â  Â  Â  "level": 1,
		Â  Â  Â  Â  "parent": "parent_id",
		Â  Â  Â  Â  "file_path": "/path/to/file",
		Â  Â  Â  Â  "is_convert_pdf": 1,
		Â  Â  Â  Â  "create_time": "2024-01-01 10:00:00",
		Â  Â  Â  Â  // ... å…¶ä»–æ‰€æœ‰å­—æ®µ
		Â  Â  },
		Â  Â  {}
		Â  ]
		
		# ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ /restful/document_doc è·å–è¿™äº›æ–‡ä»¶çš„æ–‡æœ¬å—å†…å®¹
		for file_id in files:
		    chunks = GET /restful/document_doc?file_id=file_id
		    # è¿”å›ï¼šè¯¥æ–‡ä»¶çš„æ‰€æœ‰æ–‡æœ¬å—ï¼ŒåŒ…å«å®é™…å†…å®¹
		
		    # å°†è¿™äº›æ–‡æœ¬å—ç”¨äºå¯¹è¯ä¸Šä¸‹æ–‡
		    for chunk in chunks:
		        context += chunk['content']  # ä½¿ç”¨æ–‡æœ¬å†…å®¹
		
		# è¿”å›çš„æ•°æ®ç¤ºä¾‹
		[
		Â  Â  {
		Â  Â  Â  Â  "id": "chunk_001",
		Â  Â  Â  Â  "file_id": "file_123",
		Â  Â  Â  Â  "kbase_id": 1,
		Â  Â  Â  Â  "doc_id": "doc_001",
		Â  Â  Â  Â  "content": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯...", Â # å®é™…æ–‡æœ¬å†…å®¹
		Â  Â  Â  Â  "meta_data": "{\"pageidx\": 1, \"source\": \"AIæŠ€æœ¯æ–‡æ¡£.pdf\"}",
		Â  Â  Â  Â  "create_time": "2024-01-01 10:00:00"
		Â  Â  },
		Â  Â  {
		Â  Â  Â  Â  "id": "chunk_002",
		Â  Â  Â  Â  "file_id": "file_123",
		Â  Â  Â  Â  "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„æ ¸å¿ƒæŠ€æœ¯...",
		Â  Â  Â  Â  ...
		Â  Â  },
		Â  Â  ...
		]
		# æ³¨æ„ï¼šè¿™é‡Œè¿”å›çš„æ˜¯æ–‡æœ¬å—ï¼ŒåŒ…å«å®é™…çš„å†…å®¹
```




chatchatä¸­ï¼š
- server/knowledge_base/kb_service/faiss_kb_service.py:61-79 
- do_serachï¼ˆï¼‰
	- Â  è¿”å›æœç´¢ç»“æœ
	- docs: List[Tuple[Document, float]]
	- Document: langchain.docstore.document.Document
	- float: ç›¸ä¼¼åº¦åˆ†æ•°
		- è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œå…ƒç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯Documentå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç›¸ä¼¼åº¦åˆ†æ•°

Â  Â  Â  Â  ä¾‹å¦‚ï¼š
Â  Â  Â  Â   [(Document1, 0.9), (Document2, 0.8), (Document3, 0.7)]
Â  Â  Â  Â  å…¶ä¸­ï¼ŒDocument1, Document2, Document3 æ˜¯æœç´¢åˆ°çš„æ–‡æ¡£ï¼Œ0.9, 0.8, 0.7 æ˜¯ç›¸ä¼¼åº¦åˆ†æ•°

Â  Â  Â  Â   Document å¯¹è±¡åŒ…å«ï¼š
	Â  Â  Â  Â   page_content: æ–‡æœ¬å†…å®¹
	Â  Â  Â  Â   metadata: å…ƒæ•°æ®ï¼ˆåŒ…å« source æ–‡ä»¶åç­‰ï¼‰


## å®é™…æ“ä½œ
kbaseï¼š
- åˆ›å»ºä¸€ä¸ªæ¥å£ï¼Œæœç´¢æ–‡ä»¶å¹¶è¿”å›chatéœ€è¦çš„
	- /home/user/DiMS-DAPP/docker_home/kbase_dms/api/files_kbase.pyä¸­æ·»åŠ æ¥å£
- studioä¸­åœæ­¢åé‡å¯
- æµ‹è¯•æ¥å£ï¼šcurl "http://localhost:9601/bus/files/search_chunks?key_words=test&kbase_names=kb1&top_k=5"
- åœ¨221æœåŠ¡å™¨ä¸Šæµ‹è¯•ï¼šcurl "http://192.168.127.8:9601/bus/files/search_chunks?key_words=test&kbase_names=kb1&top_k=5"


chatchat:
	
	ç”¨æˆ·è¾“å…¥é—®é¢˜
	    â†“
	å‰ç«¯è°ƒç”¨ /chat/knowledge_base_chat API
	    â†“
	ä¼ å…¥ knowledge_base_name = "ä½ çš„kbase_id"
	    â†“
	KBServiceFactory.get_service_by_name("ä½ çš„kbase_id")
	    â†“ (ä»æ•°æ®åº“è¯»å– vs_type = "kbase")
	åˆ›å»º KbaseKBService å®ä¾‹
	    â†“
	è°ƒç”¨ search_docs()
	    â†“
	GET http://app.sqs.com:9601/bus/files/search_chunks
	    â†“
	è¿”å›åŒ¹é…çš„æ–‡æ¡£ï¼Œç”¨äºç”Ÿæˆå›ç­”
### åœ¨Â chatchat æ•°æ®åº“ä¸­æ³¨å†ŒçŸ¥è¯†åº“ï¼Œå¹¶è®¾ç½® vs_type ä¸º 'kbase'

#### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºçŸ¥è¯†åº“
- çŸ¥è¯†åº“åç§°å¿…é¡»ä¸Â Kbase ç³»ç»Ÿä¸­çš„Â kbase_idÂ å®Œå…¨ä¸€è‡´

- å¦‚ä½•æŸ¥çœ‹Â Kbase ç³»ç»Ÿä¸­çš„Â kbase_idÂ ï¼š
	- åœ¨sqsæµ‹è¯•curl -G "http://localhost:9601/bus/files/search_chunks"   --data-urlencode "key_words=é˜²ç«å¢™ç­–ç•¥"   --data-urlencode "kbase_names=2"   --data-urlencode "top_k=10"
	- å½“kbase_names=2çš„æ—¶å€™èƒ½è¾“å‡ºä¸œè¥¿ï¼Œåº”è¯¥æ˜¯è¯´æ˜ç°åœ¨ç”¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¹åº”çš„çŸ¥è¯†åº“å°±æ˜¯kbase_name =2

- åˆ›å»ºçŸ¥è¯†åº“ä»£ç ï¼š
```bash
curl -X POST "http://localhost:7861/knowledge_base/create_knowledge_base"   -H "Content-Type: application/json"   -d '{
    "knowledge_base_name": "2",
    "vector_store_type": "kbase",
    "embed_model": "bge-large-zh-v1.5"
  }'
{"code":200,"msg":"å·²æ–°å¢çŸ¥è¯†åº“ 2","data":null}
```

- chatchatï¼šhttp://192.168.124.221:8501/
- kbase: http://192.168.127.8:9601/bus/files/search_chunks?key_words=test&kbase_names=kb1&top_k=5


#### ç¬¬äºŒæ­¥ï¼š
1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€chatcahtåæœç´¢ï¼Œkbaseä¸­çš„æ—¥å¿—é•¿è¿™æ ·ï¼š
>search_chunks: é˜²ç«å¢™ç­–ç•¥ç”³è¯· ['2'] 3 0.35
>
>search_docs_from_multi_kbase: 2 @ bge-large-zh-v1.5 ['2']
>
>ä½¿ç”¨æœ¬åœ°Embeddingsæ¨¡å‹: base_url='http://192.168.124.221:11434' model='quentinz/bge-large-zh-v1.5:latest' embed_instruction='passage: ' query_instruction='query: ' mirostat=None mirostat_eta=None mirostat_tau=None num_ctx=None num_gpu=None num_thread=None repeat_last_n=None repeat_penalty=None temperature=None stop=None tfs_z=None top_k=None top_p=None show_progress=False model_kwargs=None bge-large-zh-v1.5
>
>do_search result: 0.35 []
>
>search_chunks result count: 0
>
>kbase_core> 2025-12-04 19:33:20,218 INFO: 192.168.124.221 - - [04/Dec/2025 19:33:20] "GET /bus/files/search_chunks?key_words=é˜²ç«å¢™ç­–ç•¥ç”³è¯·&kbase_names=2&top_k=3&score_threshold=0.35 HTTP/1.1" 200 -

ğŸ”æ˜¯ä¸­æ–‡ç¼–ç çš„é—®é¢˜

>ä¸­æ–‡ç¼–ç å·²ç»ä¿®å¤ï¼ŒkbaseæœåŠ¡å™¨èƒ½å¤Ÿæ­£ç¡®è§£æã€‚ 
>
>AAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADPwPUor0PqZMTpwAAAAASUVORK5CYII='}, 'pageidx': 0, 'partition_pageidx': {'0': 1001, '1': 1794, '2': 1842}, 'source': 'eaef23ca-fc9f-42c9-80c1-5dbb419156e1', 'id': 'e49b61ac-09ba-44da-99f3-aa334d56e944'}), 0.93910444)]
search_chunks result count: 1
kbase_core> 2025-12-05 10:27:59,098 INFO: 192.168.124.221 - - [05/Dec/2025 10:27:59] "GET /bus/files/search_chunks?key_words=é˜²ç«å¢™&kbase_names=2&top_k=3&score_threshold=1.0 HTTP/1.1" 200 -

  

2. è€Œåœ¨chatchatæœåŠ¡å™¨çš„ç»ˆç«¯æ‰§è¡Œ
	1. (base) sqs@root-TITAN:/mnt/hs-ssd/vllms/Langchain-Chatchat$ curl -G "http://192.168.127.8:9601/bus/files/search_chunks" --data-urlencode "key_words=é˜²ç«å¢™ç­–ç•¥" --data-urlencode "kbase_names=2" --data-urlencode "top_k=10"ï¼Œ
	2. å´èƒ½åœ¨kbaseçš„æ—¥å¿—ä¸­çœ‹åˆ°AMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADBBgAAAMEGAAAAwQYAAADPwPUor0PqZMTpwAAAAASUVORK5CYII='}, 'pageidx': 0, 'partition_pageidx': {'0': 1001, '1': 1794, '2': 1842}, 'source': 'eaef23ca-fc9f-42c9-80c1-5dbb419156e1', 'id': 'e49b61ac-09ba-44da-99f3-aa334d56e944'}), 0.79011595)]

search_chunks result count: 1

kbase_core> 2025-12-04 19:36:47,220 INFO: 192.168.124.221 - - [04/Dec/2025 19:36:47] "GET /bus/files/search_chunks?key_words=é˜²ç«å¢™ç­–ç•¥&kbase_names=2&top_k=10 HTTP/1.1" 200 -

  